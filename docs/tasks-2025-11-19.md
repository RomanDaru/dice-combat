# Tasks — 2025-11-19

Daily plan for fully retiring the legacy defense v1 board and running Dice Combat on defense schema v2 only. This continues the defense integrity work from previous days.

---

## 1. Inventory & Guardrails (V1 vs V2)

- [ ] Inventory all remaining v1 entry points:
  - [ ] Confirm runtime usage of `defenseBoard`:
    - `src/game/combat/defenseBoard.ts`
    - `src/hooks/useAiDefenseResponse.ts`
    - `src/hooks/usePlayerDefenseController.ts`
    - `src/game/combat/types.ts` (board-related types)
  - [ ] Confirm dev/runtime toggles and overrides:
    - `src/components/DefenseDevPanel.tsx` (Force v1 / v2 / auto)
    - `src/context/GameController.tsx` (`defenseVersionPerHero`, overrides)
- [ ] Telemetry & stats guardrails:
  - [ ] Re-read `defenseVersionUsed` logic in `src/hooks/useDefenseActions.ts` and ensure:
    - Status-only mitigation is attributed as `"v2"` when V2 is enabled.
    - `v1WhileV2Emits` telemetry is wired correctly in `src/stats/tracker.ts`.
  - [x] Add/extend Vitest coverage so that when `ENABLE_DEFENSE_V2 === true`, any emitted `defenseVersion: "v1"` is visible to telemetry:
    - [x] New test file: `src/__tests__/defenseVersionGuard.test.ts`.
    - [x] Synthetic turn recorded with `defenseVersion: "v1"` while `enableDefenseV2: true` increments `v1WhileV2Emits`.

---

## 2. Heroes → 100% Defense Schema V2 Coverage

- [x] Ensure every hero is wired to schema V2:
  - [x] For each hero in `src/game/heroes.ts`:
    - [x] Define `defenseSchema` per `docs/defense-v2.md`.
    - [x] Define `defenseSchemaHash` via `assertDefenseSchemaValid` bootstrap.
    - [x] Set `defenseVersion: "v2"` (no `"v1"` defaults).
  - [x] Confirm `isDefenseSchemaEnabled` returns true for all heroes when they have a `defenseSchema` (no gating by version/flag).
- [ ] Parity tests between v1 board and v2 schema (migration safety net before deleting v1 board code):
  - [ ] In `src/game/combat/__tests__/defenseSchemaRuntime.test.ts` (or a new dedicated file per hero):
    - [ ] For each hero, pick a small set of representative defense dice patterns (including "no useful combo").
    - [ ] For each pattern:
      - [ ] Compute baseline with v1 (`evaluateDefenseRoll` + `resolveDefenseSelection`).
      - [ ] Compute v2 outcome (`resolveDefenseSchemaRoll`) with the same dice, attacker, defender, and `incomingDamage`.
      - [ ] Assert that base mitigation is compatible:
        - `baseBlock` matches (or is within an intentional, documented adjustment).
        - `reflect` matches where applicable.
        - Status grants are equivalent or intentionally upgraded/downgraded, and differences are documented in test descriptions.
- [ ] Feature flag default:
  - [ ] Set `ENABLE_DEFENSE_V2` default to `true` in `src/config/featureFlags.ts`.
  - [ ] Verify local dev/QA setup respects the flag and still allows a global kill-switch via env when needed.

---

## 3. Runtime Cutover – AI & Player Use Only Defense Schema Runtime

- [x] AI defense flow (`src/hooks/useAiDefenseResponse.ts`):
  - [x] In `runDefenseRoll`, use schema runtime (`resolveDefenseSchemaRoll`) whenever a hero has a `defenseSchema` (all current heroes do).
  - [x] Ensure `defenseDiceCount` matches `defenseSchema.dice` via `isDefenseSchemaEnabled` + `defenseHero.defenseSchema.dice`.
  - [ ] Follow-up: remove dead v1 board fallback once we are confident v2-only runtime is stable.
- [x] Player defense flow (`src/hooks/usePlayerDefenseController.ts`):
  - [x] When resolving a defense roll:
    - [x] Use `resolveDefenseSchemaRoll` to produce `selection` and `baseResolution` whenever a `defenseSchema` exists.
    - [x] Keep combos/options branch only as dead code for now; mitigation decisions are schema-driven.
  - [ ] Follow-up: simplify `PlayerDefenseState` so that:
    - [ ] `roll` is schema-centric (dice + schema) without v1 board combos/options.
    - [ ] Any UI that previously relied on `combos` or `selectedCombo` is either removed or re-mapped to schema data (e.g., rule hits).
- [ ] Shared defense planning:
  - [ ] Confirm `buildDefensePlan` works identically with V2 `baseResolution`:
    - [ ] Inputs: `defender`, `incomingDamage`, `baseResolution`, `spendRequests`.
    - [ ] No v1-specific assumptions about combos or board abilities.
  - [ ] Add an integration-style test in `src/game/combat/__tests__/defenseFlowV2Only.test.ts` that:
    - [ ] Runs at least one attack/defense exchange for each hero vs hero pairing.
    - [ ] Asserts:
      - `defenseVersionUsed` is never `"v1"` when `ENABLE_DEFENSE_V2` is true.
      - `defenseSchema` is present on every resolved defense turn.

---

## 4. Removal of V1 Runtime, Flags, and Types

> This section is only executed once all parity and integration tests from sections 1–3 pass and we are confident V2 is stable.

- [ ] Remove v1 defense board runtime:
  - [ ] Delete `src/game/combat/defenseBoard.ts`.
  - [ ] Remove all imports of:
    - `evaluateDefenseRoll`
    - `resolveDefenseSelection`
    - `selectDefenseOptionByCombo`
    - `selectHighestBlockOption`
  - [ ] Update `src/game/combat/types.ts`:
    - [ ] Remove `DefenseBoardOption` and any other v1-specific types/fields.
  - [ ] Clean up any debug logging that references the v1 board.
- [ ] Simplify defense versioning:
  - [ ] Update `src/defense/types.ts`:
    - [ ] Either reduce `DefenseVersion` to a single `"v2"` literal type or remove it and rely on schema presence.
  - [ ] In `src/game/types.ts`, `src/game/heroes.ts`, `src/context/GameController.tsx`:
    - [ ] Remove all branches that handle `"v1"`.
    - [ ] Normalize hero data to assume schema-based defense only.
  - [ ] `src/config/featureFlags.ts`:
    - [x] Default `ENABLE_DEFENSE_V2` to `true` (env may still disable if needed).
  - [ ] `src/components/DefenseDevPanel.tsx`:
    - [ ] Remove the "Force v1" option.
    - [ ] Keep only:
      - Automatic behavior (based on hero/schema).
      - Optional V2 debug options (e.g., schema debug mode) if still useful.
- [ ] Telemetry / stats cleanup:
  - [ ] `src/stats/types.ts`, `src/stats/tracker.ts`:
    - [ ] Stop incrementing `defenseTurnCounts.v1` and `v1WhileV2Emits` for new games.
    - [ ] Option A (preferred once old logs are migrated): remove these fields from `DefenseTelemetryTotals`.
    - [ ] Option B (transition): keep them as legacy read-only fields, but never write/update them after the cutover.

---

## 5. UI, Docs & QA for “V2 Only” World

- [ ] UI alignment with schema-only defense:
  - [ ] `src/components/DefenseSchemaPanel.tsx`:
    - [ ] Confirm it is the single source of truth for defense visualization (no v1 board references).
    - [ ] Ensure both player and AI defense use rule hits from `DefenseSchemaResolution.rules` for highlighting.
  - [ ] `src/components/PlayerAbilityList.tsx` / `src/components/OpponentAbilityList.tsx`:
    - [ ] Verify these components do not depend on v1 `defenseCombo`.
    - [ ] Ensure defense-related overlays and tooltips reference schema-driven data where applicable.
  - [ ] Dev / debug UI:
    - [ ] Confirm `DefenseDevPanel` and any debug overlays clearly label schema defense and do not mention v1.
- [ ] Documentation updates:
  - [ ] `docs/defense-v2.md`:
    - [ ] Update the "Versioning & Rollout" section to describe V2 as the only runtime.
    - [ ] Mark legacy board/v1 flow as removed (or archive its description in `docs/archive/` if needed).
  - [ ] `docs/status-core-plan.md`, `docs/status-phase-plan.md`, `docs/holy-grail-combat-flow.md`:
    - [ ] Replace any mentions of "defense board / v1" with "defense schema runtime" where appropriate.
  - [ ] This tasklist:
    - [ ] Once V1 is fully removed, add a short "Retire defense v1 board — DONE" summary at the end of this file with key commits and verification notes.
- [ ] QA & simulator validation:
  - [ ] Run `npm run qa` to ensure:
    - [ ] All unit/integration tests pass, including new defense schema tests.
  - [ ] Run `npm run sim` for key matchups (e.g., ShadowMonk vs Pyromancer):
    - [ ] Verify in generated logs:
      - `defenseVersion` is never `"v1"`.
      - `defenseSchema.damageApplied` matches `turn.actualDamage` for all logged turns.
    - [ ] Spot-check a few schema logs for clarity and correctness (block, reflect, status grants).

---

## Work log (to be filled as tasks are executed)

- Timestamp: utorok, 19. novembra 2025  (Get-Date)
  - Activity: Added defense version guard test covering `v1WhileV2Emits` telemetry and reviewed existing wiring.
  - Files touched:
    - `src/__tests__/defenseVersionGuard.test.ts`
    - `src/hooks/useDefenseActions.ts` (read-only review)
    - `src/stats/tracker.ts` (read-only review)
  - Notes:
    - Guard test uses a synthetic turn with `defenseVersion: "v1"` and `defenseMeta.enableDefenseV2: true` to assert `v1WhileV2Emits` increments as expected. No runtime behavior changed yet; this is a telemetry-only safety net before we start removing v1 paths.
- Timestamp: utorok, 19. novembra 2025  (Get-Date)
  - Activity: Flipped all heroes to defense schema v2, introduced a simple schema for Training Dummy, and wired runtime to prefer schema unconditionally.
  - Files touched:
    - `src/game/heroes.ts`
    - `src/game/combat/defenseSchemaRuntime.ts`
    - `src/config/featureFlags.ts`
    - `src/hooks/useAiDefenseResponse.ts` (schema path now always active when schema exists)
    - `src/hooks/usePlayerDefenseController.ts` (schema path now always active when schema exists)
    - `src/components/DefenseDevPanel.tsx` (removed Force v1 option)
    - `src/context/GameController.tsx` (ignore legacy v1 overrides in localStorage)
    - `src/__tests__/defenseVersionGuard.test.ts`
  - Notes:
    - All three heroes now have `defenseVersion: "v2"` and a validated `defenseSchema`; `isDefenseSchemaEnabled` no longer checks version/flag, just the presence of schema.
    - `ENABLE_DEFENSE_V2` defaults to `true`, so telemetry correctly reports v2 as enabled; legacy v1 overrides in dev HUD/localStorage are ignored or coerced to v2.
    - v1 defense board runtime paths in hooks are effectively dead code; next step is safe physical removal once we verify broader QA.
  - Commit: c6dd296 — `defense: flip heroes to schema v2 and tighten dev overrides`
