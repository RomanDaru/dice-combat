# Tasks – 2025-11-18

Daily notes for incremental work on dice-combat. This file complements higher-level docs like `prd-dice-combat.md` and the defense/status design documents.

## UI – Ability Lists

- Updated `PlayerAbilityList` (`src/components/PlayerAbilityList.tsx`):
  - Offense/Defense flip is now driven purely by whether the **player is currently defending** (`isDefenseTurn`), not by the broader turn/phase. This prevents the player panel from flipping to defense mode while AI is defending.
  - Kept the existing OFF/DEF flip UI with animations but made sure it always reflects the **player’s** role (attacker vs defender).
- Updated `OpponentAbilityList` (`src/components/OpponentAbilityList.tsx`):
  - Offense/Defense flip uses AI turn ownership (`state.turn === "ai"`) to decide which side is default.
  - Offense side now uses the same icon pipeline as the player (icons from `getAbilityIcon`, tooltip with damage and status apply text built via `getEffectDefinition`).
  - Defense side now displays the AI **Defense Schema** (v2) via `DefenseSchemaPanel` with minimal layout but full highlighting for matched/applied rules.

## UI – Ability Highlighting

- Strengthened ability highlighting in `AbilityIcons.module.css`:
  - `.ready`: subtle yellow halo and background to signal a combo is available.
  - `.selected`: stronger yellow border, brighter background, and a dedicated pulse animation (`abilityHighlightPulseStrong`) so the chosen ability stands out clearly from other ready abilities.
  - Added `prefers-reduced-motion` guard to disable the pulse for players who prefer reduced animation.

## UI – Status Roll / Dice Tray

- Refactored `DiceTrayOverlay` (`src/components/DiceTrayOverlay.tsx` + `.module.css`) to make **status rolls (Burn, future statuses)** clear and minimal:
  - Introduced **status mode** controlled by `pendingStatusClear`:
    - In status mode, standard attack/defense actions (`Roll`, `Roll Defense`, `Select Attack`, abilities) are hidden.
    - Only one primary button is shown for the player: `Status Roll` (or an informational message for AI-owned status).
  - Unified layout: Dice Tray always uses the same visual structure:
    - Header (`Dice Tray` + close button) lives directly under `.tray`.
    - `.trayContent` centers body content; `.trayBody` contains dice + actions + helper text.
  - Status roll rendering:
    - DiceGrid shows a **single status die** (read-only) when a status roll is in progress / resolved; otherwise, normal dice are used.
    - The player cannot interact with dice during a status roll (no toggling hold).
    - `statusInfo` is derived generically from `PendingStatusClear`:
      - First line: `<StatusName> stacks: N` (e.g., `Burn stacks: 1`).
      - Second line: constructed from `dieSize` and `rollThreshold` (e.g., `Roll d6. On 4-6: cleanse Burn.` or `... transfer Burn.`) – this works for any cleanse/transfer status that uses the standard roll config.
    - `statusInfo` is rendered **once**, under the actions row, using `statusPromptText` styles.
  - Helper text behavior:
    - In status mode: explains the status roll state (`Rolling status...`, final result message, or “Tap Status Roll to resolve the effect.”).
    - Outside status mode: preserves the original helper guidance for attack and defense flows.
  - Removed the old stacked overlays (`statusPrompt` + `statusRollSection`) to avoid “overlay-on-overlay” clutter; everything now lives in the standard tray layout.

## Defense Schema – AI Highlighting

- Extended `GameState` (`src/game/state.ts`) with `aiDefense.defenseSchema?: DefenseSchemaResolution | null` so we can store AI defense schema resolutions.
- Updated AI defense flow in `useAiDefenseResponse` (`src/hooks/useAiDefenseResponse.ts`):
  - After a v2 defense roll (`resolveDefenseSchemaRoll`), we now:
    - Patch AI defense state with `{ inProgress: false, defenseDice, defenseRoll, defenseSchema: schemaOutcome.schema }`.
    - This keeps the last defense schema resolution available for UI.
- Updated `DefenseSchemaPanel` (`src/components/DefenseSchemaPanel.tsx`):
  - `activeSchema` is used for both default and minimal variants; minimal variant now also respects `ruleHits`.
  - Rules are labeled as matched/applied based on `DefenseSchemaResolution.rules`:
    - `matched` if the rule’s `matched` flag is true.
    - `applied` if any effect trace has `outcome === "applied"`.
  - Minimal variant suppresses the “Matched/Awaiting match” text but still applies `ruleMatched` / `ruleApplied` CSS classes so the AI defense panel highlights the same rules as the player’s panel.
- `OpponentAbilityList` now passes `state.aiDefense.defenseSchema` as `activeSchema` to `DefenseSchemaPanel`, so AI defense rule hits are highlighted reliably (including Pyromancer, provided v2 is active for that hero via overrides/feature flags).

## Spark / PRD

- Captured product-level decisions in `docs/prd-dice-combat.md`:
  - Reinforced Spark as an MVP-defining mechanic (3 shared Sparks, comeback potential, usage at 1/2/3 Spark thresholds).
  - Documented hero archetypes (aggro, midrange, control, combo) and how they relate to Spark and status systems.
  - Clarified MVP hero roster expectations (2 full heroes minimum, archetype goals ~8 heroes, with extra heroes in reserve).

## AGENTS.md – Workflow & Documentation Guidelines

- Updated `AGENTS.md` to emphasize:
  - Frequent, small commits with clear messages tied to the actual scope of work.
  - Maintaining a written trail:
    - For bigger changes: PRDs/design docs under `docs/`.
    - For daily/iterative work (like today): `docs/tasks-YYYY-MM-DD.md` entries with concrete notes and follow-ups.

## Follow-up / TODO

- **Retire legacy defense v1 board**:
  - Goal: move fully to the v2 defense schema pipeline for all heroes and flows (player + AI), so we have a single source of truth for defense behavior.
  - Steps (high-level):
    - Ensure all relevant heroes have v2 schemas defined and validated.
    - Replace remaining v1 board usages in defense code paths with v2 equivalents, or guard them behind feature flags that are off by default once migration is complete.
    - Update docs (`defense-v2.md`, status/phase plans) to mark v1 board as deprecated/removed once the migration is finished.
  - Track this as a multi-step task across future `tasks-YYYY-MM-DD.md` files until fully done.

